#This version works well, but we use Version 1 for assignment
trigger: none
  # branches:
  #   include:
  #     - main

pool:
  vmImage: 'ubuntu-latest'

# variables:
#   dockerRegistryServiceConnection: 'HaoACRConn'
#   buildContextPath: 'src'
#   tag: '$(Build.BuildId)'

variables:
  acrName: 'devopacr'
  azureSubscriptionServiceConnection: AzureConn
  buildContextPath: 'src'
  tag: '$(Build.BuildId)'

stages:
- stage: CIStage
  displayName: CI stage

  jobs:
  - job: BuildAndPush
    displayName: Build & Push Image

    steps:
    - checkout: self
      displayName: 'Checkout source code'

    # we just use Version 1, this code still works well, uncomment to execute it
    # - task: Docker@2
    #   displayName: 'Login to ACR'
    #   inputs:
    #     command: 'login'
    #     containerRegistry: '$(dockerRegistryServiceConnection)'

    # - task: Docker@2
    #   displayName: 'Build and Push backend image to ACR'
    #   inputs:
    #     containerRegistry: '$(dockerRegistryServiceConnection)'
    #     repository: 'backend'
    #     command: 'buildAndPush'
    #     Dockerfile: '$(buildContextPath)/backend/Dockerfile'
    #     buildContext: '$(buildContextPath)/backend'
    #     tags: |
    #       $(tag)
    #       latest

    # - task: Docker@2
    #   displayName: 'Build and Push Frontend image to ACR'
    #   inputs:
    #     containerRegistry: '$(dockerRegistryServiceConnection)'
    #     repository: 'frontend'
    #     command: 'buildAndPush'
    #     Dockerfile: '$(buildContextPath)/frontend/Dockerfile'
    #     buildContext: '$(buildContextPath)/frontend'
    #     tags: |
    #       $(tag)
    #       latest
